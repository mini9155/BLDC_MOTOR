# BLDC_MOTOR
Control BLDC motor.


# BLDC 모터 제어.

## BLDC AC 모터를 제어하기 위한 프로젝트

- 방식
  - Modbus RTU
- 사용 언어
  - Python
- 사용모듈
  - ver 1 : pymodbus, PySide6, sys
  - ver 2 : pymodbus, PySide6, logging, time, sys
  - ver 3 : Serial, sturct, crcmod, sys
- 제작 기간
    - 1달
- 통신 방식
  - RS-485


1. 모드버스 RTU
  - Modbus RTU protocol은 RS-485나 RS-232등과 같이 serial 통신 환경에서 동작하기 위한 Modbus protocol의 한 종류이다. 이 protocol은 장치 ID를 통하여 각 장치를 구분하고 CRC를 이용하여 에러를 확인한다
  - 슬레이브 주소 - 1byte, 함수 코드 1 byte, 주소 High - 1byte, 주소 Low - 1byte, Data - 2byte, CRC16 - 2bye
  - ex) 0x1 0x6 0x78 0x0 0x1 0xc8 0x13 <- 이런식으로 구성이 된다
  - 끝에 2자리인 CRC16 (0xc8, 0x13)은 계산식이 따로 있으나 pymodbus 혹 crcmod의 함수를 빌려쓰면 편하다
  - 사용한 함수 코드
    04 Read Input Registers 3x (30001-39999) - 상태를 읽을 수 있다
    06 Write Single Register 0x (40001-39999) - 명령을 내릴 수 있다.
  - 시리얼로 데이터를 받았을 떄 이해하기 힘든 경우 뒤에 crc16 2개 뺴고, 앞에 슬레이브 아이디, 함수 코드를 제외하고 읽어보면 도움이 된다

2. 버전 및 방식을 바꾼 이유
   - 버전1은 아무 지식도 없는 상태에서 모터 제어부터 시작해보기 위해 간단한 인터페이스와 작동 위주의 코드를 작성하기 시작했다
   - 버전2는 간단한 기능 명령 처리 후 어느 정도의 기능 처리 및 이동 거리를 계산하기 위해 logging 모듈을 사용하기로 하였다.
   - 버전3은 logging 모듈로 데이터를 받아올 시 받아들이는 데이터가 많고 그 중에서 원하는 메세지만 받아들이기에는 변칙적인 부분이 있어 Serial 모듈을 이용하게 되었다.

  
3. 버전을 걸치면서 배우게 된 점
   - 버전2에서는 logging 중 emit 이란 모듈을 통해 메세지를 받아오는 방법을 배웠다.
   - 버전2에서 버전3로 넘어가기 전 라이브러리의 코드를 살펴보며 굳이 외부 모듈을 쓰지 않아도 내가 원하는 영역을 구현시킬 수 있는 힌트를 얻었다.
   - 모듈을 살펴보며 클래스의 구조 등을 알게 되었다.
   - 버전 3에서는 메세지를 바이트로 쓰는 방법과 바이트로 패킹을 하는 struct 모듈을 사용해보며 새로운 부분을 알게 되었다.
  
------------------------------------------------------------

문제 해결 방법

1. 모든 한 가지에 틀어박혀서는 문제가 해결되지 않는다
  - 처음 메뉴얼에 제시된 통신 속도는 9600 이었다. 이걸로 여러번 시도를 해보았고 되지 않는 걸 보며 모터 불량을 생각하였고 통신 속도 및 다른 부분을 시도할 생각을 하지 못하였다. 똑같은 걸로 하나만 시도한다고 되는 게 아니라 여러가지 가능성을 열어두고 이것저것 해봐야 하는 걸 배웠다.

2. 너무 외부 라이브러리에 의존하지 않는 점이다
  - Modbus도 기본은 Serial이다. 하지만 외부 모듈만 찾는데 급급하여 외부 모듈만 사용하였고 큰 틀 내가 맞추어 가니 불편한 점 또한 많았다. 로깅 메세지 또한 그런 문제였다. 메세지를 내가 원하는 양 만큼 받아오면서 주소를 해석하여 모터의 상태를 불러 올 수 있게 되었다.

3. 알고리즘이 얼마나 중요한지 알게 되었다
  - 프로그램은 알고리즘을 작성한대로 구현하게 된다면 추가적인 필요한 부분이 생겼을 경우 추가가 쉽지만 만약 그렇지 않은 경우 모듈을 하나 둘 추가하다 보면 코드가 어려워진다. 필요한 기능을 정리 후 하나 둘 성성 및 연계 시켜야한다는 점을 꺠닭았다.

4. 바이트가 꺠져서 보이는 현상
- 꺠지는 게 아니었다. 그냥 일정값 이상 부터는 아스키코드로 변환되어서 문자로 보이는 것 뿐이었다. for문으로 부분마다 받아와주면 알아보기 쉽게 정수로 변환하여 준다.

